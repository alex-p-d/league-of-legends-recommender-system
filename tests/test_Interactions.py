import unittest
from recommendationSystem.Interactions import Interactions
from recommendationSystem.Player import Player
from recommendationSystem.Champion import Champion
from unittest.mock import patch, Mock
from recommendationSystem.config import API_KEY

class TestInteractions(unittest.TestCase):

    @patch('recommendationSystem.Interactions.requests.get')
    @patch.object(Player, '_get_puuid')
    def test_get_top_mastery_champions_dict(self, mock_puuid, mock_get):
         
        mock_response = Mock()
        mock_puuid.return_value = 'ywGMe79XxLYi2AIirijvHFD4Kcl35bhHLRgJUD0SgbXCLTN6FFKDuycd15y7CeF4-8guzzUBKH05zQ'
        champions_info = [{'puuid': 'ywGMe79XxLYi2AIirijvHFD4Kcl35bhHLRgJUD0SgbXCLTN6FFKDuycd15y7CeF4-8guzzUBKH05zQ', 'championId': 29, 'championLevel': 24, 'championPoints': 284543, 'lastPlayTime': 1730666875000, 'championPointsSinceLastLevel': 54943, 'championPointsUntilNextLevel': -43943, 'markRequiredForNextLevel': 2, 'tokensEarned': 0, 'championSeasonMilestone': 0, 'nextSeasonMilestone': {'requireGradeCounts': {'A-': 1}, 'rewardMarks': 1, 'bonus': False, 'totalGamesRequires': 1}}, {'puuid': 'ywGMe79XxLYi2AIirijvHFD4Kcl35bhHLRgJUD0SgbXCLTN6FFKDuycd15y7CeF4-8guzzUBKH05zQ', 'championId': 81, 'championLevel': 17, 'championPoints': 193248, 'lastPlayTime': 1731108119000, 'championPointsSinceLastLevel': 40648, 'championPointsUntilNextLevel': -29648, 'markRequiredForNextLevel': 2, 'tokensEarned': 0, 'championSeasonMilestone': 0, 'nextSeasonMilestone': {'requireGradeCounts': {'A-': 1}, 'rewardMarks': 1, 'bonus': False, 'totalGamesRequires': 1}}, {'puuid': 'ywGMe79XxLYi2AIirijvHFD4Kcl35bhHLRgJUD0SgbXCLTN6FFKDuycd15y7CeF4-8guzzUBKH05zQ', 'championId': 18, 'championLevel': 12, 'championPoints': 112485, 'lastPlayTime': 1728172363000, 'championPointsSinceLastLevel': 14885, 'championPointsUntilNextLevel': -3885, 'markRequiredForNextLevel': 2, 'tokensEarned': 0, 'championSeasonMilestone': 0, 'nextSeasonMilestone': {'requireGradeCounts': {'A-': 1}, 'rewardMarks': 1, 'bonus': False, 'totalGamesRequires': 1}}, {'puuid': 'ywGMe79XxLYi2AIirijvHFD4Kcl35bhHLRgJUD0SgbXCLTN6FFKDuycd15y7CeF4-8guzzUBKH05zQ', 'championId': 157, 'championLevel': 12, 'championPoints': 104207, 'lastPlayTime': 1728847838000, 'championPointsSinceLastLevel': 6607, 'championPointsUntilNextLevel': 4393, 'markRequiredForNextLevel': 2, 'tokensEarned': 0, 'championSeasonMilestone': 0, 'nextSeasonMilestone': {'requireGradeCounts': {'A-': 1}, 'rewardMarks': 1, 'bonus': False, 'totalGamesRequires': 1}}, {'puuid': 'ywGMe79XxLYi2AIirijvHFD4Kcl35bhHLRgJUD0SgbXCLTN6FFKDuycd15y7CeF4-8guzzUBKH05zQ', 'championId': 236, 'championLevel': 10, 'championPoints': 79903, 'lastPlayTime': 1731251032000, 'championPointsSinceLastLevel': 4303, 'championPointsUntilNextLevel': 6697, 'markRequiredForNextLevel': 2, 'tokensEarned': 2, 'championSeasonMilestone': 0, 'nextSeasonMilestone': {'requireGradeCounts': {'A-': 1}, 'rewardMarks': 1, 'bonus': False, 'totalGamesRequires': 1}}, {'puuid': 'ywGMe79XxLYi2AIirijvHFD4Kcl35bhHLRgJUD0SgbXCLTN6FFKDuycd15y7CeF4-8guzzUBKH05zQ', 'championId': 350, 'championLevel': 8, 'championPoints': 73550, 'lastPlayTime': 1679182841000, 'championPointsSinceLastLevel': 19950, 'championPointsUntilNextLevel': -8950, 'markRequiredForNextLevel': 1, 'tokensEarned': 0, 'championSeasonMilestone': 0, 'nextSeasonMilestone': {'requireGradeCounts': {'A-': 1}, 'rewardMarks': 1, 'bonus': False, 'totalGamesRequires': 1}}, {'puuid': 'ywGMe79XxLYi2AIirijvHFD4Kcl35bhHLRgJUD0SgbXCLTN6FFKDuycd15y7CeF4-8guzzUBKH05zQ', 'championId': 67, 'championLevel': 7, 'championPoints': 52738, 'lastPlayTime': 1729899959000, 'championPointsSinceLastLevel': 10138, 'championPointsUntilNextLevel': 862, 'markRequiredForNextLevel': 1, 'tokensEarned': 0, 'championSeasonMilestone': 0, 'nextSeasonMilestone': {'requireGradeCounts': {'A-': 1}, 'rewardMarks': 1, 'bonus': False, 'totalGamesRequires': 1}}, {'puuid': 'ywGMe79XxLYi2AIirijvHFD4Kcl35bhHLRgJUD0SgbXCLTN6FFKDuycd15y7CeF4-8guzzUBKH05zQ', 'championId': 38, 'championLevel': 7, 'championPoints': 49301, 'lastPlayTime': 1730925535000, 'championPointsSinceLastLevel': 6701, 'championPointsUntilNextLevel': 4299, 'markRequiredForNextLevel': 1, 'tokensEarned': 3, 'championSeasonMilestone': 0, 'nextSeasonMilestone': {'requireGradeCounts': {'A-': 1}, 'rewardMarks': 1, 'bonus': False, 'totalGamesRequires': 1}}, {'puuid': 'ywGMe79XxLYi2AIirijvHFD4Kcl35bhHLRgJUD0SgbXCLTN6FFKDuycd15y7CeF4-8guzzUBKH05zQ', 'championId': 96, 'championLevel': 7, 'championPoints': 44127, 'lastPlayTime': 1730660705000, 'championPointsSinceLastLevel': 1527, 'championPointsUntilNextLevel': 9473, 'markRequiredForNextLevel': 1, 'tokensEarned': 2, 'championSeasonMilestone': 0, 'nextSeasonMilestone': {'requireGradeCounts': {'A-': 1}, 'rewardMarks': 1, 'bonus': False, 'totalGamesRequires': 1}}, {'puuid': 'ywGMe79XxLYi2AIirijvHFD4Kcl35bhHLRgJUD0SgbXCLTN6FFKDuycd15y7CeF4-8guzzUBKH05zQ', 'championId': 63, 'championLevel': 6, 'championPoints': 35323, 'lastPlayTime': 1731104688000, 'championPointsSinceLastLevel': 3723, 'championPointsUntilNextLevel': 7277, 'markRequiredForNextLevel': 1, 'tokensEarned': 0, 'championSeasonMilestone': 0, 'nextSeasonMilestone': {'requireGradeCounts': {'A-': 1}, 'rewardMarks': 1, 'bonus': False, 'totalGamesRequires': 1}}, {'puuid': 'ywGMe79XxLYi2AIirijvHFD4Kcl35bhHLRgJUD0SgbXCLTN6FFKDuycd15y7CeF4-8guzzUBKH05zQ', 'championId': 8, 'championLevel': 6, 'championPoints': 34910, 'lastPlayTime': 1730663023000, 'championPointsSinceLastLevel': 3310, 'championPointsUntilNextLevel': 7690, 'markRequiredForNextLevel': 1, 'tokensEarned': 1, 'championSeasonMilestone': 0, 'nextSeasonMilestone': {'requireGradeCounts': {'A-': 1}, 'rewardMarks': 1, 'bonus': False, 'totalGamesRequires': 1}}, {'puuid': 'ywGMe79XxLYi2AIirijvHFD4Kcl35bhHLRgJUD0SgbXCLTN6FFKDuycd15y7CeF4-8guzzUBKH05zQ', 'championId': 110, 'championLevel': 6, 'championPoints': 34226, 'lastPlayTime': 1731106765000, 'championPointsSinceLastLevel': 2626, 'championPointsUntilNextLevel': 8374, 'markRequiredForNextLevel': 1, 'tokensEarned': 2, 'championSeasonMilestone': 0, 'nextSeasonMilestone': {'requireGradeCounts': {'A-': 1}, 'rewardMarks': 1, 'bonus': False, 'totalGamesRequires': 1}}, {'puuid': 'ywGMe79XxLYi2AIirijvHFD4Kcl35bhHLRgJUD0SgbXCLTN6FFKDuycd15y7CeF4-8guzzUBKH05zQ', 'championId': 51, 'championLevel': 5, 'championPoints': 27538, 'lastPlayTime': 1729108048000, 'championPointsSinceLastLevel': 5938, 'championPointsUntilNextLevel': 4062, 'markRequiredForNextLevel': 1, 'tokensEarned': 0, 'championSeasonMilestone': 0, 'nextSeasonMilestone': {'requireGradeCounts': {'A-': 1}, 'rewardMarks': 1, 'bonus': False, 'totalGamesRequires': 1}}, {'puuid': 'ywGMe79XxLYi2AIirijvHFD4Kcl35bhHLRgJUD0SgbXCLTN6FFKDuycd15y7CeF4-8guzzUBKH05zQ', 'championId': 245, 'championLevel': 4, 'championPoints': 26068, 'lastPlayTime': 1729887333000, 'championPointsSinceLastLevel': 13468, 'championPointsUntilNextLevel': -4468, 'markRequiredForNextLevel': 1, 'tokensEarned': 0, 'championSeasonMilestone': 0, 'nextSeasonMilestone': {'requireGradeCounts': {'A-': 1}, 'rewardMarks': 1, 'bonus': False, 'totalGamesRequires': 1}}, {'puuid': 'ywGMe79XxLYi2AIirijvHFD4Kcl35bhHLRgJUD0SgbXCLTN6FFKDuycd15y7CeF4-8guzzUBKH05zQ', 'championId': 119, 'championLevel': 5, 'championPoints': 25963, 'lastPlayTime': 1730927087000, 'championPointsSinceLastLevel': 4363, 'championPointsUntilNextLevel': 5637, 'markRequiredForNextLevel': 1, 'tokensEarned': 1, 'championSeasonMilestone': 0, 'nextSeasonMilestone': {'requireGradeCounts': {'A-': 1}, 'rewardMarks': 1, 'bonus': False, 'totalGamesRequires': 1}}]
        mock_response.json.return_value = champions_info
        mock_get.return_value = mock_response

        interaction = Interactions('Denji', 'Rice', 'euw1')
        top_mastery_champions = interaction._get_top_mastery_champions_dict()
        mock_get.assert_called_with(f'https://{interaction.player.continent_region[0][0]}.api.riotgames.com/lol/champion-mastery/v4/champion-masteries/by-puuid/{mock_puuid.return_value}/top?count=15&api_key={API_KEY}') 

        expected_top_champions = {29: 284543, 81: 193248, 18: 112485, 157: 104207, 236: 79903, 350: 73550, 67: 52738, 38: 49301, 96: 44127, 63: 35323, 8: 34910, 110: 34226, 51: 27538, 245: 26068, 119: 25963}
        self.assertEqual(top_mastery_champions, expected_top_champions)

    def test_normalise_mastery_points(self):
        
        interaction = Interactions('Denji', 'Rice', 'euw1')
        normaised_top_champions = interaction._normalise_mastery_points()
        expected_normalised_top_champions = {29: 100, 81: 68, 18: 40, 157: 37, 236: 28, 350: 26, 67: 19, 38: 17, 96: 16, 63: 12, 8: 12, 110: 12, 51: 10, 245: 9, 119: 9}
        self.assertEqual(normaised_top_champions, expected_normalised_top_champions)

    def test_build_interaction_list(self):
        
        interaction = Interactions('Denji', 'Rice', 'euw1')
        player_interactions = interaction.build_interaction_list()
        expected_player_interactions = [['Denji#Rice', 'Twitch', 100], ['Denji#Rice', 'Ezreal', 68], ['Denji#Rice', 'Tristana', 40], ['Denji#Rice', 'Yasuo', 37], ['Denji#Rice', 'Lucian', 28], ['Denji#Rice', 'Yuumi', 26], ['Denji#Rice', 'Vayne', 19], ['Denji#Rice', 'Kassadin', 17], ['Denji#Rice', "Kog'Maw", 16], ['Denji#Rice', 'Brand', 12], ['Denji#Rice', 'Vladimir', 12], ['Denji#Rice', 'Varus', 12], ['Denji#Rice', 'Caitlyn', 10], ['Denji#Rice', 'Ekko', 9], ['Denji#Rice', 'Draven', 9]]
        self.assertEqual(player_interactions, expected_player_interactions)


if __name__ == '__main__':
    unittest.main()